#!/bin/bash

# Regex patterns for API keys
NEW_API_KEY_REGEX='AAPT[!-~]+AT[12]_[[:alnum:]]{8,}'
LEGACY_API_KEY_REGEX='AAPK\.?[[:alnum:]]{32}[[:alnum:]!$*+-.=@^|~]*'

# Get staged files
IFS=$'\n' read -d '' -r -a STAGED_FILES < <(git diff --cached --name-only --diff-filter=ACM)

if [ ${#STAGED_FILES[@]} -gt 0 ]; then
    echo "ðŸ” Scanning staged files for API keys..."
    for file in "${STAGED_FILES[@]}"; do
        if [[ "$file" == *.umap || "$file" == *.uasset ]]; then
            if strings "$file" | grep -Eq "$NEW_API_KEY_REGEX|$LEGACY_API_KEY_REGEX"; then
                echo "âŒ ERROR: API key detected in binary file $file"
                echo "ðŸš« Commit aborted. Please remove the key before committing."
                exit 1
            fi
        else
            CLEANED=$(git show ":$file" | tr -cd '[:print:]')
            if echo "$CLEANED" | grep -Eq "$NEW_API_KEY_REGEX|$LEGACY_API_KEY_REGEX"; then
                echo "âŒ ERROR: API key detected in text file $file"
                echo "ðŸš« Commit aborted. Please remove the key before committing."
                exit 1
            fi
        fi
    done
fi
